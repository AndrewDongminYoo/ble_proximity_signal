# ble_proximity_signal

[![Very Good Ventures][logo_white]][very_good_ventures_link_dark]
[![Very Good Ventures][logo_black]][very_good_ventures_link_light]

Developed with üíô by [Very Good Ventures][very_good_ventures_link] ü¶Ñ

![coverage][coverage_badge]
[![style: very good analysis][very_good_analysis_badge]][very_good_analysis_link]
[![License: BSD-3-Clause][license_badge]][license_link]

A Very Good Flutter Federated Plugin created by the [Very Good Ventures Team][very_good_ventures_link].

Generated by the [Very Good CLI][very_good_cli_link]. ü§ñ

## Overview

`ble_proximity_signal` is a **foreground-only** BLE proximity module for a ‚Äúmetal detector‚Äù style UX.

- **Broadcast:** advertise a short token
- **Scan:** scan nearby tokens (up to **5 targets**) and track signal strength
- **Signal processing:** smooth RSSI (EMA) and map it to **intensity (0..1)** + proximity levels

This plugin is designed for **immediate feedback UX** (sound/vibration/visual) while the app is in the foreground.
It does **not** claim background reliability or distance-in-meters.

## Packages

- `ble_proximity_signal/`: public Dart API + signal processing
- `ble_proximity_signal_platform_interface/`: shared platform contracts/models
- `ble_proximity_signal_android/`: Android implementation
- `ble_proximity_signal_ios/`: iOS implementation

## Quickstart

### 1) Start broadcasting a token

```dart
final ble = BleProximitySignal();

await ble.startBroadcast(token: 'a1b2c3d4'); // hex or base64url/base64
```

### 2) Scan and listen to proximity events

```dart
final ble = BleProximitySignal();

await ble.startScan(targetTokens: ['a1b2c3d4']); // max 5 tokens

final sub = ble.events.listen((event) {
  // event.intensity: 0..1
  // event.level: far / near / veryNear
  // event.rssi + event.smoothRssi
  print('level=${event.level} intensity=${event.intensity} rssi=${event.rssi}');
});
```

Stop when done:

```dart
await sub.cancel();
await ble.stopScan();
await ble.stopBroadcast();
await ble.dispose();
```

## Token format

`token` (broadcast) and `targetTokens` (scan) accept:

- **Hex string** (even length): `a1b2c3d4`
- **base64url / base64** (padding optional): will be decoded and normalized to hex internally

Normalization behavior:

- hex input is lowercased
- base64url/base64 input is decoded to bytes and converted to hex lowercase

If the token cannot be parsed, the Dart wrapper throws `FormatException`.

## Implementation Goals (v0.1.0)

- Foreground **advertising + scanning** on iOS/Android (latest devices).
- Filter up to **5 target tokens** and emit a continuous `Stream<ProximityEvent>`.
- RSSI smoothing (EMA), hysteresis for near/veryNear, and intensity mapping.
- Example app supports broadcast start/stop, scan start/stop, and debug tools.

**Non-goals (v0.1.0):**

- background guarantees
- distance-in-meters
- rolling IDs (v0.2+)
- built-in sound/vibration/notifications (left to the app layer)

## Platform notes

### iOS

- Foreground-only scanning/advertising (expected behavior for v0.1.0).
- The example app includes a **debug device list** (scan all peripherals) and can probe discovered peripherals via GATT service discovery.

### Android

- Foreground-only by design (v0.1.0).
- Device identifiers in scan results can be **randomized/unstable** on some Android versions/devices.
- Integration tests require a physical device or emulator with BLE support.

> Permissions and platform policy vary by OS version/device. If scanning/broadcasting fails, check Bluetooth state, permissions, and device capabilities first.

## Example app

The example app (`ble_proximity_signal/example`) provides:

- Start/stop scan
- Start/stop broadcast
- ‚Äúmetal detector‚Äù style UX using proximity intensity (beep/visual)
- Debug mode: scan all peripherals and show visible devices (refreshed periodically)
- Debug probe: tap a visible device to run a **service/characteristic discovery dump**

Run:

```sh
cd ble_proximity_signal/example
flutter run
```

## Debug: discover services

If you enable debug scanning (scan all peripherals) you can probe a device:

```dart
final dump = await ble.debugDiscoverServices(deviceId: deviceId);
print(dump);
```

The dump includes:

- device id + name
- discovered services
- characteristics + properties (read/write/notify/etc.)

## Integration tests üß™

This repository uses [fluttium][fluttium_link] for integration tests (located in the example app).

Install the CLI: [fluttium_cli install guide][fluttium_install]

Run the flow:

```sh
cd ble_proximity_signal/example
fluttium test flows/test_platform_name.yaml
```

> Note: the provided flow is a **UI smoke test** for the example app. If you change UI labels/buttons,
> update the flow steps accordingly.

[coverage_badge]: ble_proximity_signal/coverage_badge.svg
[license_badge]: https://img.shields.io/badge/license-BSD-green.svg
[license_link]: https://opensource.org/license/bsd-3-clause
[logo_black]: https://raw.githubusercontent.com/VGVentures/very_good_brand/main/styles/README/vgv_logo_black.png#gh-light-mode-only
[logo_white]: https://raw.githubusercontent.com/VGVentures/very_good_brand/main/styles/README/vgv_logo_white.png#gh-dark-mode-only
[very_good_analysis_badge]: https://img.shields.io/badge/style-very_good_analysis-B22C89.svg
[very_good_analysis_link]: https://pub.dev/packages/very_good_analysis
[very_good_cli_link]: https://github.com/VeryGoodOpenSource/very_good_cli
[very_good_ventures_link]: https://verygood.ventures/?utm_source=github&utm_medium=banner&utm_campaign=core
[very_good_ventures_link_dark]: https://verygood.ventures/?utm_source=github&utm_medium=banner&utm_campaign=core#gh-dark-mode-only
[very_good_ventures_link_light]: https://verygood.ventures/?utm_source=github&utm_medium=banner&utm_campaign=core#gh-light-mode-only
[fluttium_link]: https://fluttium.dev/
[fluttium_install]: https://fluttium.dev/docs/getting-started/installing-cli
